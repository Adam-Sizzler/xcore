#!/usr/bin/env bash

# –£–∫–∞–∑—ã–≤–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
DIR_XRAY="/usr/local/etc/xray/"
DIR_REVERSE_PROXY="/usr/local/reverse_proxy/"

API_URL="/usr/local/etc/xray/xray api statsquery"
dataBasePath="/usr/local/reverse_proxy/data.db"
xrayLogAccess="/usr/local/etc/xray/access.log"
logFile="/var/log/xrp-ipl.log"

extract_data() {
  local CONFIG_FILE_HAPROXY="/etc/haproxy/haproxy.cfg"

  SUB_JSON_PATH=$(grep -oP 'use_backend http-sub if \{ path /.*? \}' "$CONFIG_FILE_HAPROXY" | grep -oP '(?<=path /).*?(?= \})')
  IP4=$(grep -oP 'acl host_ip hdr\(host\) -i \K[\d\.]+' "$CONFIG_FILE_HAPROXY")
  DOMAIN=$(grep -oP 'crt /etc/haproxy/certs/\K[^.]+(?:\.[^.]+)+(?=\.pem)' "$CONFIG_FILE_HAPROXY")
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
execute_transaction() {
  local queries="$1"
  sqlite3 "$dataBasePath" <<EOF
BEGIN TRANSACTION;
$queries
COMMIT;
EOF
}

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
init_db() {
  sqlite3 "$dataBasePath" <<EOF
    CREATE TABLE IF NOT EXISTS traffic_stats (
      source TEXT PRIMARY KEY,
      session_uplink INTEGER DEFAULT 0,
      session_downlink INTEGER DEFAULT 0,
      uplink INTEGER DEFAULT 0,
      downlink INTEGER DEFAULT 0
    );

    CREATE TABLE IF NOT EXISTS clientsStats (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      email TEXT UNIQUE,
      level INTEGER,
      xray_uuid TEXT,
      activity_status TEXT,
      enabled TEXT,
      created TEXT,
      sub_end TEXT,
      sub_duration TEXT,
      ip TEXT,
      ip_limit INTEGER DEFAULT 1,
      uplink INTEGER DEFAULT 0,
      downlink INTEGER DEFAULT 0,
      session_uplink INTEGER DEFAULT 0,
      session_downlink INTEGER DEFAULT 0
    );
EOF
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ
extract_users_xray_server() {
  jq -r '.inbounds[] | select(.tag == "vless_raw") | .settings.clients[] | "\(.email) \(.level) \(.id)"' "${DIR_XRAY}config.json"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ API —Ç–æ–ª—å–∫–æ –ø–æ inbounds, outbounds
extract_traffic_stats() {
  /usr/local/etc/xray/xray api statsquery | jq -r '.stat[] |
    select((.name | contains("user") | not) and
           (.name | contains("api") | not) and
           (.name | contains("blocked") | not)) |
    "\(.name | split(">>>") | del(.[0, 2]) | join(" ")) \(.value // 0)"'
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∫–æ–Ω—Ñ–∏–≥–µ Xray
delete_user_from_db() {
  # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ SQL –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π
  local update_queries=""
  # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ email –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ Xray
  mapfile -t users_xray < <(extract_users_xray_server)
  # –ò–∑–≤–ª–µ–∫–∞–µ–º email –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
  mapfile -t users_db < <(sqlite3 "$dataBasePath" "SELECT email FROM clientsStats;")

  for user in "${users_db[@]}"; do
    if [[ ! " ${users_xray[*]} " =~ " $user " ]]; then
      # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
      update_queries+="DELETE FROM clientsStats WHERE email = '$user'; "
    fi
  done

  # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø—Ä–æ—Å—ã
  [[ -n "$update_queries" ]] && execute_transaction "$update_queries"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD-HH
get_file_creation_date() {
  local USER_FILE_PATH="/var/www/${SUB_JSON_PATH}/vless_raw/${USERNAME}.json"
  
  # –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö —Å —ç–ø–æ—Ö–∏ UNIX
  file_creation_time=$(stat --format=%W "$USER_FILE_PATH" 2>/dev/null)

  # –ï—Å–ª–∏ –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ (–±–æ–ª—å—à–µ 0), –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD-HH
  if [[ "$file_creation_time" -gt 0 ]]; then
    date -d @$file_creation_time "+%Y-%m-%d-%H"
  else
    echo "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
  fi
}

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
add_user_to_db() {
  # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ SQL –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π
  local update_queries=""
  # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ email –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ Xray
  mapfile -t clients < <(extract_users_xray_server)
  # –°—Ç—Ä–æ–∫–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ

  for client in "${clients[@]}"; do
    IFS=' ' read -r USERNAME LEVEL XRAY_UUID <<< "$client"
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞
    CREATED_CLIENT=$(get_file_creation_date)
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    update_queries+="INSERT OR IGNORE INTO clientsStats (email, level, xray_uuid, activity_status, enabled, created) 
    VALUES ('$USERNAME', $LEVEL, '$XRAY_UUID', 'offline', 'true', '$CREATED_CLIENT'); "
  done

  # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø—Ä–æ—Å—ã
  [[ -n "$update_queries" ]] && execute_transaction "$update_queries"
}

previous_stats=""
current_stats=""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –∑–∞–ø–∏—Å–∏ –≤ SQLite
update_proxy_stats() {
  # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ SQL –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π
  local update_queries=""
  # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
  current_stats=$(extract_traffic_stats)

  # –ï—Å–ª–∏ previous_stats –ø—É—Å—Ç–∞—è, —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ä–∞–∑–Ω–∏—Ü—ã
  if [ -z "$previous_stats" ]; then
    previous_stats="$current_stats"
    return
  fi

  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤
  declare -A current_values previous_values diff_values

  # –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
  while read -r first second value; do
    source="$first $second"
    current_values["$source"]=$value
  done <<< "$current_stats"

  # –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
  while read -r first second value; do
    source="$first $second"
    previous_values["$source"]=$value
  done <<< "$previous_stats"

  declare -A uplink_values downlink_values session_uplink_values session_downlink_values

  for key in "${!current_values[@]}"; do
    current=${current_values[$key]}
    previous=${previous_values[$key]:-0}

    diff=$((current - previous < 0 ? 0 : current - previous))

    source=$(echo "$key" | awk '{print $1}')
    direction=$(echo "$key" | awk '{print $2}')

    if [[ "$direction" == "uplink" ]]; then
      uplink_values["$source"]=$diff
      session_uplink_values["$source"]=$current
    elif [[ "$direction" == "downlink" ]]; then
      downlink_values["$source"]=$diff
      session_downlink_values["$source"]=$current
    fi
  done

  for source in "${!uplink_values[@]}"; do
    uplink=${uplink_values[$source]:-0}
    downlink=${downlink_values[$source]:-0}
    session_uplink=${session_uplink_values[$source]:-0}
    session_downlink=${session_downlink_values[$source]:-0}

    update_queries+="INSERT OR REPLACE INTO traffic_stats (source, uplink, downlink, session_uplink, session_downlink) 
                             VALUES ('$source', $uplink, $downlink, $session_uplink, $session_downlink)
                             ON CONFLICT(source) DO UPDATE 
                             SET uplink = uplink + $uplink,
                                 downlink = downlink + $downlink,
                                 session_uplink = $session_uplink,
                                 session_downlink = $session_downlink; "
  done
  # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø—Ä–æ—Å—ã
  [[ -n "$update_queries" ]] && execute_transaction "$update_queries"
  # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
  previous_stats="$current_stats"
}

update_user_stats() {
  # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ SQL –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π
  local update_queries=""
  # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∏—Ö –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
  mapfile -t users_data < <(sqlite3 "$dataBasePath" "SELECT email, downlink FROM clientsStats;")

  declare -A downlink_map

  for user_data in "${users_data[@]}"; do
    IFS='|' read -r email prev_downlink <<< "$user_data"
    downlink_map["$email"]="$prev_downlink"
  done

  for email in "${!downlink_map[@]}"; do
    uplink_value=0
    downlink_value=0

    for stat in "${stats[@]}"; do
      IFS=' ' read -r stat_name stat_value <<< "$stat"
      case "$stat_name" in
        "user>>>${email}>>>traffic>>>uplink") uplink_value="$stat_value";;
        "user>>>${email}>>>traffic>>>downlink") downlink_value="$stat_value";;
      esac
    done

    prev_downlink=${downlink_map["$email"]:-0}
    diff=$((downlink_value - prev_downlink))

    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    if [ "$diff" -lt 100 ]; then
      online_status="‚ùå inactive"
    elif [ "$diff" -lt 25000 ]; then
      online_status="üí§ idle"
    elif [ "$diff" -lt 12000000 ]; then
      online_status="üü¢ online"
    else
      online_status="üî• high activity"
    fi

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    update_queries+="UPDATE clientsStats SET uplink = $uplink_value, downlink = $downlink_value, activity_status = '$online_status' WHERE email = '$email'; "
  done

  # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø—Ä–æ—Å—ã
  [[ -n "$update_queries" ]] && execute_transaction "$update_queries"
}

update_enable_status() {
  # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ SQL –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π
  local update_queries=""
  local lua_file="/etc/haproxy/.auth.lua"
  declare -A uuid_status

  while IFS= read -r line; do
    if [[ "$line" =~ \[\"([a-f0-9\-]{36})\"\]\ =\ (true|false) ]]; then
      uuid="${BASH_REMATCH[1]}"
      value="${BASH_REMATCH[2]}"
      uuid_status["$uuid"]="$value"
    fi
  done < "$lua_file"

  # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ enabled –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö UUID –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
  for uuid in "${!uuid_status[@]}"; do
    value=${uuid_status[$uuid]}

    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è enabled –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    update_queries+="UPDATE clientsStats SET enabled = '$value' WHERE xray_uuid = '$uuid'; "
  done

  # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø—Ä–æ—Å—ã
  [[ -n "$update_queries" ]] && execute_transaction "$update_queries"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤—Å–µ—Ö IP –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
clear_all_ips_in_db() {
    sqlite3 "$dataBasePath" "UPDATE clientsStats SET ip = '[]';"
}

# –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è IP —Å —Ç–∞–π–º—à—Ç–∞–º–ø–æ–º
add_ip_to_array() {
    local email="$1"
    local ip="$2"
    local current_time=$(date +%s)

    # –ï—Å–ª–∏ IP —É–∂–µ –µ—Å—Ç—å ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ —Ç–∞–π–º—à—Ç–∞–º–ø
    if [[ -z "${email_ips[$email]}" ]]; then
        email_ips["$email"]="$ip"
        email_ip_timestamps["$email"]="$current_time"
    else
        IFS=',' read -ra existing_ips <<< "${email_ips[$email]}"
        IFS=',' read -ra existing_times <<< "${email_ip_timestamps[$email]}"

        local ip_found=0
        for i in "${!existing_ips[@]}"; do
            if [[ "${existing_ips[$i]}" == "$ip" ]]; then
                existing_times[$i]="$current_time"
                ip_found=1
                break
            fi
        done

        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π IP, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç –≤ –º–∞—Å—Å–∏–≤–µ
        if [[ $ip_found -eq 0 ]]; then
            existing_ips+=("$ip")
            existing_times+=("$current_time")
        fi

        # –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤—ã
        email_ips["$email"]=$(IFS=,; echo "${existing_ips[*]}")
        email_ip_timestamps["$email"]=$(IFS=,; echo "${existing_times[*]}")
    fi
}

# –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö IP
remove_expired_ips() {
    local current_time=$(date +%s)

    for email in "${!email_ips[@]}"; do
        IFS=',' read -ra ips <<< "${email_ips[$email]}"
        IFS=',' read -ra timestamps <<< "${email_ip_timestamps[$email]}"

        local new_ips=()
        local new_times=()

        for i in "${!ips[@]}"; do
            local ip="${ips[$i]}"
            local timestamp="${timestamps[$i]}"
            local age=$((current_time - timestamp))

            if (( age <= IP_LIFETIME )); then
                new_ips+=("$ip")
                new_times+=("$timestamp")
            fi
        done

        email_ips["$email"]=$(IFS=,; echo "${new_ips[*]}")
        email_ip_timestamps["$email"]=$(IFS=,; echo "${new_times[*]}")
    done
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –ª–æ–≥–æ–≤
parse_log_line() {
    local line="$1"
    if [[ "$line" =~ from\ tcp:([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+):[0-9]+\ accepted\ .*email:\ ([a-zA-Z0-9_]+) ]]; then
        add_ip_to_array "${BASH_REMATCH[2]}" "${BASH_REMATCH[1]}"
    fi
}

# –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è IP –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
save_ips_to_db() {
    for email in "${!email_ips[@]}"; do
        local new_ips="[\"${email_ips[$email]//,/\"],[\"}\"]"

        sqlite3 "$dataBasePath" "UPDATE clientsStats SET ip = '$new_ips' WHERE email = '$email';"
    done
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–≥
ban_time() {
    # –û—á–∏—â–∞–µ–º —Ñ–∞–π–ª –ª–æ–≥–æ–≤ –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é
    > "$logFile"
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º email, —Å–ø–∏—Å–æ–∫ IP –∏ ip_limit –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    sqlite3 "$dataBasePath" "SELECT email, ip, ip_limit FROM clientsStats;" | while IFS='|' read -r email ip ip_limit; do
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ IP –Ω–µ –ø—É—Å—Ç–æ–π
        if [[ "$ip" != "[]" ]]; then
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É IP –≤ –º–∞—Å—Å–∏–≤, —É–¥–∞–ª—è—è –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —Å–∫–æ–±–∫–∏
            IFS=',' read -r -a ip_array <<< "$(echo $ip | sed 's/\[//g' | sed 's/\]//g')"
            
            # –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ IP –≤ –º–∞—Å—Å–∏–≤–µ
            ip_count=${#ip_array[@]}
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ IP –∑–Ω–∞—á–µ–Ω–∏–µ –≤ ip_limit
            if (( ip_count > ip_limit )); then
                # –î–ª—è –∫–∞–∂–¥–æ–≥–æ IP –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É –≤ –ª–æ–≥
                for ip_entry in "${ip_array[@]}"; do
                    timestamp=$(date "+%Y/%m/%d %H:%M:%S")
                    echo "$timestamp [LIMIT_IP] Email = $email || SRC = [$ip_entry]" >> "$logFile"
                    echo "–ó–∞–ø–∏—Å–∞–Ω–æ –≤ –ª–æ–≥: Email = $email, IP = $ip_entry"
                done
            fi
        fi
    done
}

ip_limit() {
  # –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ IP –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (60 —Å–µ–∫—É–Ω–¥ = 1 –º–∏–Ω—É—Ç–∞)
  IP_LIFETIME=120

  # –ê—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã: email -> IP –∏ email -> —Ç–∞–π–º—à—Ç–∞–º–ø—ã
  declare -A email_ips
  declare -A email_ip_timestamps

  clear_all_ips_in_db
  
  while IFS= read -r line; do
    parse_log_line "$line"
  done < "$xrayLogAccess"

  save_ips_to_db

  > "$xrayLogAccess"
}

display_stats() {
  echo
  echo "  üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤:"
  sqlite3 "$dataBasePath" <<EOF
.headers on
.mode column
SELECT 
  email AS "Email",
  level AS "LvL",
--  xray_uuid AS "UUID",
  ip AS "Ips",
  ip_limit AS "Lim_ip",
  activity_status AS "Status",
  enabled AS "Enabled",
  created AS "Created",
  printf("%.2f MB", uplink / 1024.0 / 1024.0) AS "Upload",
  printf("%.2f MB", downlink / 1024.0 / 1024.0) AS "Download",
  printf("%.2f MB", session_uplink / 1024.0 / 1024.0) AS "S Upload",
  printf("%.2f MB", session_downlink / 1024.0 / 1024.0) AS "S Download"
FROM clientsStats;
EOF

  echo
  echo "  üåê –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:"
  # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä—è–º–æ –≤ SQL
  sqlite3 "$dataBasePath" <<EOF
.headers on
.mode column
SELECT
  source AS "Source",
  CASE 
    WHEN session_uplink >= 1024 * 1024 * 1024 THEN printf("%.2f GB", session_uplink / 1024.0 / 1024.0 / 1024.0)
    WHEN session_uplink >= 1024 * 1024 THEN printf("%.2f MB", session_uplink / 1024.0 / 1024.0)
    WHEN session_uplink >= 1024 THEN printf("%.2f KB", session_uplink / 1024.0)
    ELSE printf("%d Bytes", session_uplink)
  END AS "S Upload",
  CASE 
    WHEN session_downlink >= 1024 * 1024 * 1024 THEN printf("%.2f GB", session_downlink / 1024.0 / 1024.0 / 1024.0)
    WHEN session_downlink >= 1024 * 1024 THEN printf("%.2f MB", session_downlink / 1024.0 / 1024.0)
    WHEN session_downlink >= 1024 THEN printf("%.2f KB", session_downlink / 1024.0)
    ELSE printf("%d Bytes", session_downlink)
  END AS "S Download",
  CASE 
    WHEN uplink >= 1024 * 1024 * 1024 THEN printf("%.2f GB", uplink / 1024.0 / 1024.0 / 1024.0)
    WHEN uplink >= 1024 * 1024 THEN printf("%.2f MB", uplink / 1024.0 / 1024.0)
    WHEN uplink >= 1024 THEN printf("%.2f KB", uplink / 1024.0)
    ELSE printf("%d Bytes", uplink)
  END AS "Upload",
  CASE 
    WHEN downlink >= 1024 * 1024 * 1024 THEN printf("%.2f GB", downlink / 1024.0 / 1024.0 / 1024.0)
    WHEN downlink >= 1024 * 1024 THEN printf("%.2f MB", downlink / 1024.0 / 1024.0)
    WHEN downlink >= 1024 THEN printf("%.2f KB", downlink / 1024.0)
    ELSE printf("%d Bytes", downlink)
  END AS "Download"
FROM traffic_stats;
EOF
  echo
}

task_10_sec() {
  local previous_stats=""
  while true; do
    clear
    update_proxy_stats
    update_user_stats
    display_stats
    sleep 10
  done
}

task_60_sec() {
  while true; do
    update_enable_status
    ip_limit
    ban_time
    sleep 50
  done
}

statistics_collection() {
  extract_data
  if [ ! -f "$dataBasePath" ]; then
    init_db
  fi
  delete_user_from_db
  add_user_to_db
  task_10_sec &  # –ó–∞–ø—É—Å–∫ –∑–∞–¥–∞—á–∏ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
#  task_60_sec &  # –ó–∞–ø—É—Å–∫ –∑–∞–¥–∞—á–∏ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
}

cleanup() {
  echo "–ó–∞–≤–µ—Ä—à–∞—é —Ñ–æ–Ω–æ–≤—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
  for job in $(jobs -p); do
    kill "$job" || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å —Å ID $job"
  done
}

trap cleanup SIGINT SIGTERM
statistics_collection
wait
